import{useLocation as e,matchPath as t,Link as o,unstable_HistoryRouter as n,useRoutes as r}from"react-router-dom";export*from"react-router-dom";import a,{useLayoutEffect as c,useCallback as l,useRef as i,useMemo as s,useEffect as m,useState as h}from"react";import{useEventListener as d,useBoolean as u,useInViewport as f,useSize as p}from"ahooks";import{createBrowserHistory as E}from"history";import g from"lodash";import{Loading as y}from"nc-simple-loading";import v from"styled-components";const w={useWatcher:(e,t)=>{d(e,({detail:e})=>{t(e)})},emitWatcher:(e,t)=>window.dispatchEvent(new CustomEvent(e,{detail:t}))},x=(t,o)=>()=>{const{pathname:n}=e();return c(()=>{w.emitWatcher("CHANGE_LAYOUTS",{[n]:{header:(null==o?void 0:o.header)||"index",content:(null==o?void 0:o.content)||"index",footer:(null==o?void 0:o.footer)||"index"}})},[]),a.createElement(t,null)},k=E(),F=a.memo(({onReload:e,error:t})=>a.createElement(a.Fragment,null,t," ",a.createElement("button",{onClick:e},"Re-fetch")));let b;const C=a.memo(()=>a.createElement($,null,a.createElement(y,null))),$=v.div(b||(b=(e=>e)`
  position: fixed;
  top: 0;
  left: 0;
  height: 100%;
  width: 100%;
  z-index: 999999999;
  background: white;
  display: flex;
  align-items: center;
  justify-contents: space-between;
`)),H=a.memo(({factory:e,children:t})=>{const[o,{setTrue:n,setFalse:r}]=u(!e.isFetched),i=l(()=>{e.isFetched||(n(),Promise.all([new Promise(e=>setTimeout(e,1e3)),e.fetch()]).finally(r))},[e.isFetched]);return c(i,[e.isFetched]),o?a.createElement(C,null):e.error?a.createElement(F,{error:e.error,onReload:i}):a.createElement(e.Component,null,t)});class j{constructor(e){var t=this;this.isFetched=!1,this.Component=C,this.error="",this.fetch=async function(){for(let e=0;e<3;e++)try{const{default:e}=await t.factory();t.Component=e,t.isFetched=!0,t.error="";break}catch(o){if(2!==e)continue;console.error("[nc-toolkits]",o.message),t.error=o.message}},this.factory=e}}const L=e=>{const t=g.pickBy(import.meta.glob("/src/{layouts,pages}/**/*.tsx"),function(t,o){return g.startsWith(o,e)}),o={};for(const n in t)o[n.replace(e,"").replace(/\.tsx$/,"").replace(/^\//,"")]=()=>import(`${n}?t=${Date.now()}`);return o},W=e=>["/",e.replace(/index$/,"").toLowerCase()].join(""),A=e=>e.split(/\]/).join("").split(/\/\[/).join("/:"),{routes:O,routePreloads:P}=(()=>{const e=L("/src/pages"),t=[];for(const o in e){const n=/^(\/[a-z][^\]/\s]*|\/\[[a-z][^/\s]*\])+$|^\/$/g;let r=W(o);if(!n.test(r)){console.warn("[nc-toolkits]",o,"is invalid path.");continue}r=A(r);const c=new j(e[o]);t.push({path:r,factory:c,element:a.createElement(H,{factory:c})})}return{routes:t.map(e=>g.pick(e,["path","element"])),routePreloads:t.map(e=>g.pick(e,["path","factory"]))}})(),R=a.memo(a.forwardRef((e,n)=>{const r=i((null==n?void 0:n.current)||n||null),[c]=f(r),l=s(()=>"string"==typeof e.to?e.to:e.to.pathname,[JSON.stringify(e.to)]),h=s(()=>P.find(e=>t(e.path,l)),[l]);return m(()=>{c&&h&&h.factory&&(h.factory.isFetched||h.factory.fetch())},[c]),a.createElement(o,Object.assign({},e,{ref:r}))})),T=()=>{const e=i(null),t=p(e);return[e,s(()=>(null==t?void 0:t.height)||0,[t])]},z=e=>{const t={},o=L("/src/layouts/"+e);for(const e in o)t[e]=new j(o[e]);return t},N={headers:z("headers"),footers:z("footers"),contents:z("contents")},S=a.memo(({name:e,children:t,component:o})=>{const n=s(()=>{const t=N[o];return"none"!==e&&t&&(t[e]||t.index)||null},[o,e]);return n?a.createElement(H,{factory:n},t):a.createElement(a.Fragment,null,t)});let B,G,U=e=>e;const Y=a.memo(()=>{const e=k.location.pathname,[t,o]=h({}),r=s(()=>t[e],[t,e]),[c,l]=T(),[i,m]=T();return w.useWatcher("CHANGE_LAYOUTS",e=>{o(t=>({...t,...e}))}),a.createElement(n,{history:k},(null==r?void 0:r.header)&&a.createElement(D,{ref:c},a.createElement(S,{component:"headers",name:r.header})),(null==r?void 0:r.content)&&a.createElement(_,{headerHeight:l,footerHeight:m},a.createElement(S,{component:"contents",name:null==r?void 0:r.content},a.createElement(J,null))),Boolean(null==r?void 0:r.content)||a.createElement("main",null,a.createElement(J,null)),(null==r?void 0:r.footer)&&a.createElement("footer",{ref:i},a.createElement(S,{component:"footers",name:null==r?void 0:r.footer})))}),_=v.main(B||(B=U`
  min-height: ${0};
`),({headerHeight:e=0,footerHeight:t=0})=>`calc(100vh - ${e+t}px)`),D=v.header(G||(G=U`
  position: sticky;
  top: 0;
  left: 0;
  background: white;
  box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
`)),J=a.memo(()=>r(O));export{R as Link,Y as Router,k as history,w as watcher,x as withLayout};
//# sourceMappingURL=index.modern.js.map
